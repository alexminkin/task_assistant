## **Проблематика:**

Агенты не могут проводить сравнение в удобном формате

## **Цель:**

Реализовать таблицу представления для раздела "Подборки" (сейчас называется "Избранное"), в которой будет возможно сравнивать объекты путем вертикального скролла.

## **Польза для юзера:**

Повышение удобства подбора недвижимости



## **Background (Product)**

Как сделано у TrendAgent (<https://spb.trendagent.ru/comparison/>):

![](image2.png){width=514px}

![](image3.png){width=513px}

![](image4.png){width=70%}

## 

## 

## **Список User Stories: (Product)**

## **1\. Добавить объект в сравнение**

| **Модуль** | **US \ JTBD** | **Критерии приемки** |
| --- | --- | --- |
| Подборки | Как агент<br />Я хочу добавить объект в сравнение<br />Чтобы лучше сопоставить все найденные опции | 1\. Раздел "Подборки" переименован в "Презентации"<br />2\. В раздел "Презентация" добавлены  табы "Подборка" и "Сравнение"<br />3\. В обоих табах  добавлено число объектов (для сравнений оно по умолчанию 0, и не может быть выше числа объектов в подборке)<br />4\. На уровень объектов в табе "Подборка" добавлена кнопка "Добавить в сравнение" (при добавлении меняется на кнопку "Убрать из сравнения") |

## **2\. Сравнить объекты**

| **Модуль** | **US \ JTBD** | **Критерии приемки** |
| --- | --- | --- |
| Подборки | Как агент<br />Я хочу сравнить объекты<br />Чтобы лучше провести подбор для клиента | 1\. Объекты в табе "Сравнение" представляют собой узкие и длинные карточки-колонки с данными, которые можно скроллить сверху вниз.  <br />2\. Соответствующие данные в  карточках находятся на одной горизонтали, чтобы было удобнее сравнивать <br />3\. У карточек есть кнопка "Убрать из сравнения"<br />4\. При скролле заголовки карточек остаются на экране, чтобы пользователь всегда видел, какие данные относятся к какой карточке<br/>5\. На адаптиве карточки-колонки перелистываются с помощью кнопок слайдера<br /><br />Набор данных для карточки (как на десктопе, так и на адаптиве) представлен в таблице [Поля карточки объекта в Сравнении](https://youtrack.rct24.ru/articles/RC-A-301/Draft-BFT-Sravneniya#polya-kartochki-obuekta-v-sravnenii) |

## **Дизайн-макеты: (Design)**

[https://www.figma.com/design/UQRcmaATAdAzsHgijEfcsW/3.0-Агрегатор-недвижимости?node-id=3388-68195&t=EPw0owflWQZUCNye-1](https://www.figma.com/design/UQRcmaATAdAzsHgijEfcsW/3.0-%D0%90%D0%B3%D1%80%D0%B5%D0%B3%D0%B0%D1%82%D0%BE%D1%80-%D0%BD%D0%B5%D0%B4%D0%B2%D0%B8%D0%B6%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8?node-id=3388-68195&t=EPw0owflWQZUCNye-1)

## **Поля карточки объекта в Сравнении**

| Раздел | Поле | Пример данных / Описание данных |
| --- | --- | --- |
| Шапка | Тип квартиры | 2к. Апартаменты №609 в ЖК Роттердам |
|  | Номер объекта |  |
|  | ЖК |  |
| Планировка | Планировка | Галерея изображений объекта с возможностью перелистывания картинок |
| О квартире | Цена со скидкой | ₽ 17 034 556 |
|  | Цена базовая | ₽ 22 642 100 |
|  | Срок сдачи | 3 кв. 2026 |
|  | S общая | 34,17 м2 |
|  | Этаж | 6 |
|  | Отделка | White-box |
| Расположение | Адрес | Москва, Ул. Пушкина, д. 10 |
|  | Метро | Пушкинская - 24 мин. пешком, 12 мин. на автомобиле<br />Лермонтовская - 27 мин. пешком,  14 мин. на автомобиле |
| ЖК | Галерея | Галерея изображений ЖК с возможностью перелистывания картинок |
|  | Застройщик | ФСК |
|  | Тип дома | Кирпично-монолитный |

## 

## **Функциональные требования: (ФТ) - US для разработки (Frontend сравнение объектов)**

### **1. User Story: Сравнивать объекты недвижимости**

**Описание:**
Пользователь (агент) может добавить объекты в сравнение, просматривать их в виде вертикальных карточек-колонок с возможностью скролла и фиксированным заголовком, а также убирать объекты из сравнения. Интерфейс реализован по макетам Figma, поддерживает адаптивность и мгновенное обновление состояния без перезагрузки страницы.

| **Модуль** | **US \\ JTBD** | **Критерии приемки** |
| --- | --- | --- |
| Презентации | Как агент<br>Я хочу сравнивать объекты недвижимости<br>Чтобы быстро и удобно сопоставлять параметры для клиента | 1. В разделе «Презентации» реализованы вкладки «Подборка» и «Сравнение» с отображением количества объектов.<br>2. Для каждого объекта в сравнении отображается вертикальная карточка с полями: тип квартиры, номер, ЖК, планировка (галерея), цена со скидкой, цена базовая, срок сдачи, площадь, этаж, отделка, адрес, метро, галерея ЖК, застройщик, тип дома.<br>3. Карточки выровнены по горизонтали, однотипные поля на одной линии.<br>4. В каждой карточке реализован вертикальный скролл, шапка закреплена.<br>5. В каждой карточке есть кнопка «Убрать из сравнения», по клику отправляется PUT-запрос и UI обновляется.<br>6. Во вкладке «Подборка» у каждого объекта есть кнопка «Добавить в сравнение»/«Убрать из сравнения», состояние меняется динамически.<br>7. Все действия выполняются без перезагрузки страницы.<br>8. На мобильных устройствах карточки перелистываются свайпом или стрелками.<br>9. Верстка и элементы управления соответствуют макетам Figma.<br>10. При ошибке API отображается всплывающее уведомление.<br>11. В случае отсутствия объектов для сравнения отображается placeholder с рекомендацией добавить объекты. |

#### **Frontend**
1. Реализовать вкладки «Подборка» и «Сравнение» с динамическими счетчиками.
2. Отображать объекты в сравнении в виде вертикальных карточек-колонок с полями по таблице «Поля карточки объекта в Сравнении».
3. Обеспечить горизонтальное выравнивание карточек и вертикальный скролл с закреплённой шапкой.
4. Добавить кнопки «Добавить/Убрать в сравнение» с мгновенным обновлением UI.
5. Реализовать адаптивность: на мобильных устройствах карточки перелистываются свайпом/стрелками.
6. Обеспечить обработку ошибок API с отображением уведомлений.
7. UI должен соответствовать макетам Figma.

#### **Критерии приемки:**
- Вкладки и счетчики работают корректно.
- Карточки отображаются и выровнены по горизонтали, поля на одной линии.
- Скролл и закрепление шапки реализованы.
- Кнопки работают, UI обновляется без перезагрузки.
- Мобильная версия соответствует макетам, перелистывание работает.
- Ошибки API отображаются пользователю.
- Визуальное соответствие Figma (цвета, размеры, отступы, иконки).

**Пример/Кейс:**
- **Кейс:** Агент добавляет несколько квартир в сравнение, переходит во вкладку «Сравнение», сравнивает параметры, убирает одну из квартир, видит обновлённый список без перезагрузки страницы.
- **Действие:** Добавление/удаление объектов, скролл карточек, перелистывание на мобильном, обработка ошибок.
- **Результат:** Список сравнения обновляется мгновенно, интерфейс соответствует макетам, ошибки отображаются корректно.

### **2. User Story: Управлять сравнением объектов (Backend)**

**Описание:**
Система должна предоставлять API для управления списком сравнения объектов недвижимости для клиента: получать список объектов в сравнении, добавлять и удалять объекты, обеспечивать валидацию, корректные коды ответов и публикацию событий для downstream-систем.

**Дополнительно:**
- Для каждого объекта в подборке возвращается статус `comparison` (true/false) — участвует ли объект в сравнении.
- Для изменения статуса сравнения реализован отдельный метод (PUT), принимающий параметры `apartment_id` и `comparison`.
- На странице сравнения используются только объекты с `comparison = true`.

| **Модуль**      | **US \ JTBD**                                                                 | **Критерии приемки**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|-----------------|-------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| API сравнения   | Как backend<br>Я хочу предоставлять методы для управления сравнением объектов<br>Чтобы фронтенд и другие сервисы могли корректно работать с этим списком | 1. Реализован GET-метод `/api/v1/estate/selections/client/{client_id}` — возвращает подборки клиента, для каждого объекта в массиве `apartments` добавлено поле `comparison` (boolean), отражающее участие в сравнении.<br>2. Реализован GET-метод `/api/v1/estate/selections/comparison/client/{client_id}` — возвращает только те объекты, у которых `comparison = true`.<br>3. Реализован PUT-метод `/api/v1/estate/selections/comparison/client/{client_id}` — изменяет статус сравнения для объекта (параметры: `apartment_id`, `comparison`).<br>4. Все методы валидируют входные параметры (существование client_id, apartment_id, типы данных).<br>5. В случае ошибок возвращаются корректные коды и сообщения (404, 422 и др.).<br>6. Ответы соответствуют спецификации (Laravel API Resource или Pydantic).<br>7. При изменении состояния публикуется событие ComparisonChanged.<br>8. Поддерживается пагинация (meta-блок).<br>9. API покрыто тестами на основные сценарии и ошибки. |

#### **Backend**
1. **GET** `/api/v1/estate/selections/client/{client_id}`  
   - Возвращает подборки клиента.
   - В каждом объекте массива `apartments` присутствует поле `comparison` (boolean), отражающее участие объекта в сравнении.
   - Пример:
     ```json
     {
       "id": 114,
       "apartments": [
         {
           "id": 721709,
           "comparison": true,
           // ... остальные поля
         }
       ]
     }
     ```
2. **GET** `/api/v1/estate/selections/comparison/client/{client_id}`  
   - Возвращает только те объекты, у которых `comparison = true`.
   - Формат ответа аналогичен обычному списку подборок, но фильтруется по статусу сравнения.
3. **PUT** `/api/v1/estate/selections/comparison/client/{client_id}`  
   - Изменяет статус сравнения для объекта.
   - Принимает параметры:
     ```json
     {
       "apartment_id": 123,
       "comparison": true
     }
     ```
   - Если `comparison = true` — объект добавляется в сравнение, если `false` — убирается.
   - Валидация: существование client_id, apartment_id, типы данных.
   - В случае ошибок возвращаются коды 404, 422 и соответствующие сообщения.
4. **Валидация и обработка ошибок**
   - Все методы валидируют входные параметры.
   - В случае ошибок возвращаются корректные коды и сообщения (404 — не найдено, 422 — ошибка валидации и т.д.).
5. **Форматирование ответов**
   - Ответы форматируются через API Resource (Laravel) или Pydantic (FastAPI).
6. **Публикация событий**
   - При изменении статуса сравнения публикуется событие `ComparisonChanged` для downstream-систем.
7. **Пагинация**
   - Все методы поддерживают пагинацию (meta-блок в ответе).
8. **Тестирование**
   - Методы покрыты тестами на основные сценарии (успех, ошибки, edge-cases).

#### **Критерии приемки:**
- Методы API работают согласно спецификации.
- В ответах присутствует поле `comparison` для каждого объекта.
- GET-метод для сравнения возвращает только объекты с `comparison = true`.
- PUT-метод корректно меняет статус сравнения.
- Ошибки и валидация реализованы корректно.
- События публикуются при изменениях.
- Ответы соответствуют формату.
- Покрытие тестами основных сценариев и ошибок.

**Пример/Кейс:**
- **Кейс:** Клиент добавляет объект в сравнение через PUT, затем получает список через GET, удаляет объект, при ошибке получает 422 с описанием.
- **Действие:** Запросы к API, добавление/удаление, получение списка, обработка ошибок.
- **Результат:** API возвращает актуальный список, ошибки обрабатываются, события публикуются.

## **Схема взаимодействия между системами: (BA) - (Атыя)**

Общая схема взаимодействия между системами

## **Затрагиваемые платформы: (BA) - (Атыя / Владимир)**

| Платформа     | Затронуто? | Комментарий                                                  |
| ------------- |:----------:|--------------------------------------------------------------|
| Сайт фронтенд | Да         | Будет дорабатываться компонент сравнения объектов            |
| Сайт бэкенд   | Да         | Будет дорабатываться сервис API сравнения (добавление/удаление и получение данных) |
| Битрикс       | Нет        |                                                              |
| API Gateway   | Нет        |                                                              |
| Интеграция    | Нет        |                                                              |
| Парсер        | Нет        |                                                              |

## 3. Технические требования

### 3.1. Архитектурные требования
- Система состоит из Frontend (SPA на React), Backend (Laravel API), БД (PostgreSQL).
- Взаимодействие между Frontend и Backend осуществляется по REST API.
- Backend реализует бизнес-логику сравнения объектов, хранит статусы сравнения.
- Требования: масштабируемость backend, обработка ошибок, логирование, безопасность API (аутентификация, авторизация).
- Все компоненты должны быть независимы и расширяемы.

### 3.2. API
| Метод | Endpoint | Описание | Параметры | Ответ |
|-------|----------|----------|-----------|-------|
| GET   | /api/v1/estate/selections/client/{client_id} | Получить подборки клиента с полем comparison | client_id (UUID) | Список объектов с полем comparison |
| GET   | /api/v1/estate/selections/comparison/client/{client_id} | Получить только объекты в сравнении | client_id (UUID) | Список объектов с comparison=true |
| PUT   | /api/v1/estate/selections/comparison/client/{client_id} | Изменить статус сравнения объекта | client_id (UUID), apartment_id (int), comparison (bool) | Статус операции |
